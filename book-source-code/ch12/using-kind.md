## Run multi-cluster in `kind`
> NOTE: Execute the following commands from the root of the repository.

Get the script for creating the clusters:
```
wget https://gist.githubusercontent.com/rinormaloku/fd744ee94f8f4c8d0960f9bc65b89c42/raw/9614dba9fe083ab1e837d01aab48359509b27a22/create-cluster.sh
```

Create two clusters:
```
chmod +x ./create-cluster.sh

./create-cluster.sh 1 west-cluster us west
./create-cluster.sh 2 east-cluster us east
```

Create aliases to make subsequent commands simpler:
```
alias kwest='kubectl --context="west-cluster"'
alias keast='kubectl --context="east-cluster"'
alias iwest='istioctl --context="west-cluster"'
alias ieast='istioctl --context="east-cluster"'
```

Set up the certificates
```
kwest create namespace istio-system
kwest create secret generic cacerts -n istio-system \
--from-file=ch12/certs/west-cluster/ca-cert.pem \
--from-file=ch12/certs/west-cluster/ca-key.pem \
--from-file=ch12/certs/root-cert.pem \
--from-file=ch12/certs/west-cluster/cert-chain.pem

keast create namespace istio-system
keast create secret generic cacerts -n istio-system \
--from-file=ch12/certs/east-cluster/ca-cert.pem \
--from-file=ch12/certs/east-cluster/ca-key.pem \
--from-file=ch12/certs/root-cert.pem \
--from-file=ch12/certs/east-cluster/cert-chain.pem
```

Add network labels:
```
kwest label namespace istio-system \
topology.istio.io/network=west-network

keast label namespace istio-system \
topology.istio.io/network=east-network
```

Install istio:
```
istioctl --context="west-cluster" install -y \
-f ch12/controlplanes/cluster-west.yaml

istioctl --context="east-cluster" install -y \
-f ch12/controlplanes/cluster-east.yaml
```

Run some workloads:

```
kwest create ns istioinaction
kwest label namespace istioinaction istio-injection=enabled
kwest -n istioinaction apply -f ch12/webapp-deployment-svc.yaml
kwest -n istioinaction apply -f ch12/webapp-gw-vs.yaml
kwest -n istioinaction apply -f ch12/catalog-svc.yaml

keast create ns istioinaction
keast label namespace istioinaction istio-injection=enabled
keast -n istioinaction apply -f ch12/catalog.yaml
```

## Set up cross cluster connection

We need to modify the kubeconfigs generated by istioctl. For that reason write those to a file initially
```
ieast x create-remote-secret --name="east-cluster" > east-cluster.yaml

iwest x create-remote-secret --name="west-cluster" > west-cluster.yaml
```

Update both files `east-cluster.yaml` and `west-cluster.yaml` with the following changes:
1. Removing the `certificate-authority-data` field
2. Allow insecure access (DO NOT DO IN PROD)

```yaml
# This file is autogenerated, do not edit.
apiVersion: v1
kind: Secret
metadata:
  annotations:
    networking.istio.io/cluster: east-cluster
  creationTimestamp: null
  labels:
    istio/multiCluster: "true"
  name: istio-kubeconfig
  namespace: istio-system
stringData:
  config: |
    apiVersion: v1
    clusters:
    - cluster:
        ## remove certificate-authority-data
        ## certificate-authority-data: <redacted>
        
        ## add insecure-skip-tls-verify: true
		insecure-skip-tls-verify: true
        server: https://192.168.0.35:7002
      name: east-cluster
    contexts:
    - context:
        cluster: east-cluster
        user: east-cluster
      name: east-cluster
    current-context: east-cluster
    kind: Config
    preferences: {}
    users:
    - name: east-cluster
      user:
        token: <redacted>
```

After updating both files, apply it to the cluster:

```
keast apply -f west-cluster.yaml
kwest apply -f east-cluster.yaml
```

## Expose services across clusters

Expose the services across clusters, by setting up East-west gateways and configuring those.

```
ieast install -y -f ch12/gateways/cluster-east-eastwest-gateway.yaml
keast apply -n istio-system -f ch12/gateways/expose-services.yaml
iwest install -y -f ch12/gateways/cluster-west-eastwest-gateway.yaml
kwest apply -n istio-system -f ch12/gateways/expose-services.yaml
```

## Verify cross-cluster access

Get the IP of the ingress gateway in the west cluster.
```
EXT_IP=$(kwest -n istio-system get svc istio-ingressgateway \
-o jsonpath='{.status.loadBalancer.ingress[0].ip}')
```

Execute a curl command.
```
curl http://$EXT_IP/api/catalog -H "Host: webapp.istioinaction.io"
```

This will print the catalog which is retrieved from the second cluster.